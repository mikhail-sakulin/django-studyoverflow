{% load posts_tags %}
{% load widget_tweaks %}

<div class="card text-white rounded shadow-sm px-4">
  <div class="card-body px-0">

    <!-- Автор и время -->
    <div class="d-flex align-items-center mb-2">
      <img id="avatar-comment"
           src="{% if comment.author.avatar_small_size1 %}
                  {{ comment.author.avatar_small_size1.url }}
                {% elif comment.author.avatar %}
                  {{ comment.author.avatar.url }}
                {% endif %}"
           alt="{{ comment.author.username }}"
           class="rounded-circle">

      <div>
        <div class="d-flex align-items-center mb-1">
          <a href="" class="username-comment author-name me-1">{{ comment.author.username }}</a>
          {% if comment.reply_to %}
            <span class="text-warning me-1">ответил пользователю</span>
            <a href="" class="username-comment author-name">{{ comment.reply_to.author.username }}</a>
          {% endif %}
        </div>

        <div id="time_create-time_update-comment" class="text-secondary">
          Опубликовано: {{ comment.time_create|date:"d.m.Y г. H:i" }}
          {% if comment.is_edited %}
            &nbsp;|&nbsp; Изменено: {{ comment.time_update|date:"d.m.Y г. H:i" }}
          {% endif %}
        </div>
      </div>
    </div>

    <hr class="mt-1 mb-2">

    <!-- Блок содержимого комментария -->
    <div id="comment-content-{{ comment.id }}" class="content-comment text-white mt-1">
      {{ comment.content|markdown_safe|safe }}
    </div>

    <!-- Кнопки управления -->
    <div class="d-flex justify-content-end mt-2">
      {% if user == comment.author %}
        <!-- Для автора - кнопка редактирования -->
        <button type="button"
                class="btn btn-outline-warning btn-sm edit-comment-btn"
                data-comment-id="{{ comment.id }}">
          Редактировать
        </button>
      {% else %}
        <!-- Для других пользователей - кнопка ответа -->
        <button type="button"
                class="btn btn-outline-light btn-sm reply-btn"
                data-comment-id="{{ comment.id }}">
          Ответить
        </button>
      {% endif %}
    </div>

    <!-- Скрытая форма ответа (для других пользователей) -->
    <div id="reply-form-{{ comment.id }}" class="reply-form-container mt-3" style="display:none;">
      <form method="POST" action="{% url 'posts:comment_create' comment.post.pk comment.post.slug %}">
        {% csrf_token %}
        <input type="hidden" name="parent_comment" value="{% if comment.parent_comment %}{{ comment.parent_comment.id }}{% else %}{{ comment.id }}{% endif %}">
        <input type="hidden" name="reply_to" value="{{ comment.id }}">

        <div class="mb-2">
          {{ comment_form.content|attr:"placeholder:Ответ на комментарий..." }}

          <!-- Ошибки поля content -->
          {% if comment_form.content.errors %}
            <div class="text-danger fs-6">
              {% for err in comment_form.content.errors %}
                <div class="mt-1">
                  {{ err }}
                </div>
              {% endfor %}
            </div>
          {% endif %}
        </div>

        <!-- Ошибки формы, не связанные с полями -->
        <div class="text-danger fs-6 mb-3">
          {% for error in comment_form.non_field_errors %}
            {{ error }}<br>
          {% endfor %}
        </div>

        <div class="d-flex justify-content-between mt-3">
          <button type="submit" class="btn btn-outline-warning btn-sm">Отправить</button>
          <button type="button" class="btn btn-outline-light btn-sm cancel-reply-btn px-3" data-comment-id="{{ comment.id }}">
            Скрыть
          </button>
        </div>
      </form>
    </div>

    <!-- Скрытая форма редактирования (для автора) -->
    <div id="edit-form-{{ comment.id }}" class="edit-form-container mt-3" style="display:none;">
      <form method="POST" action="{% url 'posts:comment_update' comment.post.pk comment.post.slug comment.pk %}">
        {% csrf_token %}

        <input type="hidden" name="parent_comment" value="{{ comment.parent_comment.id }}">
        <input type="hidden" name="reply_to" value="{{ comment.reply_to.id }}">

        <div class="mb-2">
          <textarea id="id_content"
                    name="content"
                    class="form-control"
                    rows="5"
                    placeholder="Редактировать комментарий...">{{ comment.content }}</textarea>

          <!-- Ошибки поля content -->
          {% if comment_form.content.errors %}
            <div class="text-danger fs-6">
              {% for err in comment_form.content.errors %}
                <div class="mt-1">
                  {{ err }}
                </div>
              {% endfor %}
            </div>
          {% endif %}

        </div>

        <!-- Ошибки формы, не связанные с полями -->
        <div class="text-danger fs-6 mb-3">
          {% for error in comment_form.non_field_errors %}
            {{ error }}<br>
          {% endfor %}
        </div>

        <div class="d-flex justify-content-between mt-3">
          <button type="submit" class="btn btn-outline-warning btn-sm">Сохранить</button>
          <button type="button" class="btn btn-outline-light btn-sm cancel-edit-btn px-3" data-comment-id="{{ comment.id }}">
            Отмена
          </button>
        </div>
      </form>
    </div>

  </div>
</div>
